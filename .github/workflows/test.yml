name: test-workflow
run-name: ${{ github.actor }} is learning GitHub Actions
on: [push, pull_request]
jobs:
  run-tests:
    runs-on: ubuntu-20.04
    steps:
    - name: setup
      shell: bash
      run: |
        echo "::group::Setup"
        sudo apt-get update
        sudo apt-get install -y qemu-kvm
        echo "::endgroup::"
    - name: kvm permissions
      shell: bash
      # Taken from here:
      # https://stackoverflow.com/questions/37300811/android-studio-dev-kvm-device-permission-denied/61984745#61984745
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' \
            | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
    - uses: actions/checkout@v3
    - name: env info
      shell: bash
      run: |
        id
        ls -l /dev/kvm
        pwd
        ls -lh
    - name: run kvm
      shell: bash
      run: |
        qemu-system-x86_64 \
          -machine accel=kvm,type=q35 \
          -kernel ./bzImage \
          -nographic -m 128m \
          -no-reboot \
          -append 'console=ttyS0 panic=-1'
